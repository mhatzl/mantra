<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mantra Report</title>
</head>
<body>
    <header>
        <h1>Mantra Report</h1>
        <p><strong>This report was generated by <em>mantra</em> with the following criteria:</strong></p>
        <ul>
            <li>
                <p><strong>Tracing</strong></p>
                <p class="criteria-content">{{ trace_criteria }}</p>
            </li>
            <li>
                <p><strong>Test Coverage</strong></p>
                <p class="criteria-content">{{ test_coverage_criteria }}</p>
            </li>
            <li>
                <p><strong>Passed Test Coverage</strong></p>
                <p class="criteria-content">{{ test_passed_coverage_criteria }}</p>
            </li>
        </ul>
    </header>

    <nav>

    </nav>

    <main>
        <section>
            <h2>Overview</h2>
            <ul>
                <li>
                    <p><strong>Number of requirements:</strong> {{ overview.req_cnt }}</p>
                </li>
                <li>
                    <p><strong>Number of traced requirements:</strong> {{ overview.traced_cnt }} ({{ overview.traced_ratio * 100 }}%)</p>
                </li>
                <li>
                    <p><strong>Number of covered requirements:</strong> {{ overview.covered_cnt }} ({{ overview.covered_ratio * 100 }}%)</p>
                </li>
                <li>
                    <p><strong>Number of passed requirements:</strong> {{ overview.passed_cnt }} ({{ overview.passed_ratio * 100 }}%)</p>
                </li>
            </ul>
        </section>
        <section>
            <h2>Requirements</h2>
            {% for req in requirements %}
                <h3 id="{{ req.id }}">{{ req.id }}{% if req.manual %} (manual){% elif req.deprecated %} (deprecated){% endif %}</h3>
                <div class="req-origin">
                    <!-- TODO: display origin -->
                </div>
                
                {% if req.parent %}
                <p>Parent: {{ req.parent }}</p>
                {% endif %}
                
                {% if req.children %}
                <p>Children:</p>
                <ul>
                    {% for child_id in req.children %}
                    <li>{{ child_id }}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                <p>Traced: {{ req.trace_info.traced }}</p>

                {% if req.trace_info.direct_traces | length > 0 %}
                    <p>Direct traces ({{ req.trace_info.direct_traces | length }}):</p>
                    <table>
                        <tr>
                            <th>filepath</th>
                            <th>line</th>
                        </tr>
                        {% for trace in req.trace_info.direct_traces %}
                        <tr>
                            <td>{{ trace.filepath }}</td>
                            <td>{{ trace.line }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% endif %}
               
                {% if req.trace_info.indirect_traces | length > 0 %}
                    <p>Direct traces ({{ req.trace_info.indirect_traces  | length }}):</p>
                    <table>
                        <tr>
                            <th>traced-id</th>
                            <th>filepath</th>
                            <th>line</th>
                        </tr>
                        {% for trace in req.trace_info.indirect_traces %}
                        <tr>
                            <td>{{ trace.traced_id }}</td>
                            <td>{{ trace.filepath }}</td>
                            <td>{{ trace.line }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% endif %}

                <p>Covered: {{ req.test_coverage_info.covered }}</p>
                <p>Passed coverage: {{ req.test_coverage_info.passed }}</p>

                {% if req.test_coverage_info.direct_coverage | length > 0 %}
                    <p>Direct coverage ({{ req.test_coverage_info.direct_coverage | length }}):</p>
                    <table>
                        <tr>
                            <th>test-run-name</th>
                            <th>test-run-date</th>
                            <th>test-name</th>
                            <th>filepath</th>
                            <th>line</th>
                        </tr>
                        {% for coverage in req.test_coverage_info.direct_coverage %}
                        <tr>
                            <td>{{ coverage.test_run_name }}</td>
                            <td>{{ coverage.test_run_date | date(format="%Y-%m-%d %H:%M:%S", timezone="Europe/Berlin") }}</td>
                            <td>{{ coverage.test_name }}</td>
                            <td>{{ coverage.filepath }}</td>
                            <td>{{ coverage.line }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% endif %}

                {% if req.test_coverage_info.indirect_coverage | length > 0 %}
                    <p>Indirect coverage ({{ req.test_coverage_info.indirect_coverage | length }}):</p>
                    <table>
                        <tr>
                            <th>covered-id</th>
                            <th>test-run-name</th>
                            <th>test-run-date</th>
                            <th>test-name</th>
                            <th>filepath</th>
                            <th>line</th>
                        </tr>
                        {% for coverage in req.test_coverage_info.indirect_coverage %}
                        <tr>
                            <td>{{ coverage.covered_id }}</td>
                            <td>{{ coverage.test_run_name }}</td>
                            <td>{{ coverage.test_run_date | date(format="%Y-%m-%d %H:%M:%S", timezone="Europe/Berlin") }}</td>
                            <td>{{ coverage.test_name }}</td>
                            <td>{{ coverage.filepath }}</td>
                            <td>{{ coverage.line }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% endif %}

                {% if req.test_coverage_info.failed_coverage | length > 0 %}
                    <p>Failed coverage ({{ req.test_coverage_info.failed_coverage | length }}):</p>
                    <table>
                        <tr>
                            <th>failed-id</th>
                            <th>test-run-name</th>
                            <th>test-run-date</th>
                            <th>test-name</th>
                            <th>filepath</th>
                            <th>line</th>
                        </tr>
                        {% for failed in req.test_coverage_info.failed_coverage %}
                        <tr>
                            {% if failed.covered_id %}
                            <td>{{ failed.covered_id }}</td>
                            {% else %}
                            <td>{{ req.id }}</td>
                            {% endif %}

                            <td>{{ failed.test_run_name }}</td>
                            <td>{{ failed.test_run_date | date(format="%Y-%m-%d %H:%M:%S", timezone="Europe/Berlin") }}</td>
                            <td>{{ failed.test_name }}</td>
                            <td>{{ failed.filepath }}</td>
                            <td>{{ failed.line }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% endif %}

                {% if req.verified_info | length > 0 %}
                    <p>Verified in reviews:</p>
                    <table>
                        <tr>
                            <th>review-name</th>
                            <th>review-date</th>
                            <th>comment</th>
                        </tr>
                        {% for info in req.verified_info %}
                        <tr>
                            <td>{{ info.review_name }}</td>
                            <td>{{ info.review_date | date(format="%Y-%m-%d %H:%M:%S", timezone="Europe/Berlin") }}</td>
                            <td>{{ info.comment }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% endif %}
            {% endfor %}
        </section>
        <section>
            <h2>Tests</h2>
            <h3>Overview</h3>
            <ul>
                <li>
                    <p><strong>Number of tests:</strong> {{ tests.overview.test_cnt }}</p>
                </li>
                <li>
                    <p><strong>Number of ran tests:</strong> {{ tests.overview.ran_cnt }} ({{ tests.overview.ran_ratio * 100 }}%)</p>
                </li>
                <li>
                    <p><strong>Number of passed tests:</strong> {{ tests.overview.passed_cnt }} ({{ tests.overview.passed_ratio * 100 }}%)</p>
                </li>
                <li>
                    <p><strong>Number of failed tests:</strong> {{ tests.overview.failed_cnt }} ({{ tests.overview.failed_ratio * 100 }}%)</p>
                </li>
                <li>
                    <p><strong>Number of skipped tests:</strong> {{ tests.overview.skipped_cnt }} ({{ tests.overview.skipped_ratio * 100 }}%)</p>
                </li>
            </ul>

            {% if tests.test_runs | length > 0 %}
                <h3>Test runs:</h3>
                {% for test_run in tests.test_runs %}
                    <p>Name: {{ test_run.name }}</p>
                    <p>Date: {{ test_run.date | date(format="%Y-%m-%d %H:%M:%S", timezone="Europe/Berlin") }}</p>
                    <strong>Overview</strong>
                    <ul>
                        <li>
                            <p><strong>Number of tests:</strong> {{ test_run.overview.test_cnt }}</p>
                        </li>
                        <li>
                            <p><strong>Number of ran tests:</strong> {{ test_run.overview.ran_cnt }} ({{ test_run.overview.ran_ratio * 100 }}%)</p>
                        </li>
                        <li>
                            <p><strong>Number of passed tests:</strong> {{ test_run.overview.passed_cnt }} ({{ test_run.overview.passed_ratio * 100 }}%)</p>
                        </li>
                        <li>
                            <p><strong>Number of failed tests:</strong> {{ test_run.overview.failed_cnt }} ({{ test_run.overview.failed_ratio * 100 }}%)</p>
                        </li>
                        <li>
                            <p><strong>Number of skipped tests:</strong> {{ test_run.overview.skipped_cnt }} ({{ test_run.overview.skipped_ratio * 100 }}%)</p>
                        </li>
                    </ul>

                    {% if test_run.tests | length > 0 %}
                    <strong>Tests:</strong>
                    {%for test in test_run.tests %}
                        <p>Name: {{ test.name }}</p>
                        <p>Location: '{{ test.filepath }}'@{{ test.line }}</p>
                        <p>State:
                            {%if test.state == 'Passed' %}
                            passed
                            {% elif 'Skipped' in test.state %}
                            skipped (reason: {% if test.state['Skipped'].reason %}
                                {{ test.state['Skipped'].reason }}
                                {% else %}unknown{% endif %})
                            {% endif %}
                        </p>
                    {% endfor %}
                    {% endif %}

                    <details>
                        <summary>Logs during test run</summary>
                        <p><strong>Logs:</strong></p>
                        <p>{{ test_run.logs }}</p>
                    </details>
                {% endfor %}
            {% endif %}
        </section>
        <section>
            <h2>Reviews</h2>
            {% for review in reviews %}
            <p>Name: {{ review.name }}</p>
            <p>Date: {{ review.date | date(format="%Y-%m-%d %H:%M:%S", timezone="Europe/Berlin") }}</p>
            <p>Reviewer: {{ review.reviewer }}</p>
            <p>Comment: {{ review.comment }}</p>
            <p><strong>Verified requirements:</strong></p>
            <table>
                <tr>
                    <th>Requirement ID</th>
                    <th>Comment</th>
                </tr>
                {% for req in review.verified_reqs %}
                <tr>
                    <td>{{ req.id }}</td>
                    <td>{{ req.comment }}</td>
                </tr>
                {% endfor %}
            </table>
            {% endfor %}
        </section>
    </main>

    <footer>
        Report generated at {{ now() | date(format="%Y-%m-%d %H:%M:%S", timezone="Europe/Berlin") }}
    </footer>
</body>
</html>